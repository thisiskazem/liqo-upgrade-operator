---
# Version compatibility matrix ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: liqo-version-compatibility
  namespace: {{ .Values.liqoNamespace }}
  labels:
    {{- include "liqo-upgrade-operator.labels" . | nindent 4 }}
    app.kubernetes.io/component: upgrade-compatibility
data:
  compatibility.yaml: |
    # Liqo Version Compatibility Matrix
    # Format: sourceVersion: [list of compatible targetVersions]
    #
    # This matrix defines which Liqo versions can be upgraded to which target versions.
    # The controller will check this matrix before starting any upgrade process.
    #
    # Only FORWARD upgrades are supported (v1.0.0 -> v1.0.1, not v1.0.1 -> v1.0.0)
    {{- range $source, $targets := .Values.compatibility }}
    {{ $source }}:
      {{- range $targets }}
      - {{ . }}
      {{- end }}
    {{- end }}
---
# Target descriptors ConfigMap (dynamically populated during upgrade)
apiVersion: v1
kind: ConfigMap
metadata:
  name: liqo-target-descriptors
  namespace: {{ .Values.liqoNamespace }}
  labels:
    {{- include "liqo-upgrade-operator.labels" . | nindent 4 }}
    app.kubernetes.io/component: target-descriptor
data: {}
# Target descriptors are dynamically generated from Liqo Helm charts
# during the validation phase (Step 5.5) based on:
#   - Current version (detected from liqo-controller-manager image tag)
#   - Target version (from LiqoUpgrade.spec.targetVersion)
#
# The generator Job fetches the Liqo Helm chart for each version,
# renders it with `helm template`, and parses the output to create
# accurate component descriptors with correct args and env vars.

